<!DOCTYPE html>
<html lang="en">

<head>
    <base href="https://cdn.jsdelivr.net/gh/genizy/web-port@main/buckshot-roulette/index.html">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0">
    <title>Buckshot Roulette</title>
    <link rel="stylesheet" href="style.css">
    <link id="-gd-engine-icon" rel="icon" type="image/png" href="buckshot-roulette.icon.png" />
    <link rel="apple-touch-icon" href="buckshot-roulette.apple-touch-icon.png" />

    <style>
        @keyframes blinkCursor {
            50% {
                border-right-color: transparent;
            }
        }

        @keyframes typeAndDelete {
            0%, 10% {
                width: 0;
            }

            45%, 55% {
                width: 6.2em;
            }

            90%, 100% {
                width: 0;
            }
        }

        .terminal-loader {
            border: 0.1em solid #333;
            background-color: #1a1a1a;
            color: #0f0;
            font-family: "Courier New", Courier, monospace;
            font-size: 1em;
            padding: 1.5em 1em;
            width: 12em;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            border-radius: 4px;
            position: relative;
            overflow: hidden;
            box-sizing: border-box;
            margin: 50px auto;
            text-align: left;
        }

        .terminal-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1.5em;
            background-color: #333;
            border-top-left-radius: 4px;
            border-top-right-radius: 4px;
            padding: 0 0.4em;
            box-sizing: border-box;
        }

        .terminal-controls {
            float: right;
        }

        .control {
            display: inline-block;
            width: 0.6em;
            height: 0.6em;
            margin-left: 0.4em;
            border-radius: 50%;
            background-color: #777;
        }

        .control.close {
            background-color: #e33;
        }

        .control.minimize {
            background-color: #ee0;
        }

        .control.maximize {
            background-color: #0b0;
        }

        .terminal-title {
            float: left;
            line-height: 1.5em;
            color: #eee;
        }

        .text {
            display: inline-block;
            white-space: nowrap;
            overflow: hidden;
            border-right: 0.2em solid green;
            animation:
                typeAndDelete 4s steps(11) infinite,
                blinkCursor 0.5s step-end infinite alternate;
            margin-top: 1.5em;
        }
    </style>
</head>

<body>
    <script src="main.js"></script>

    <!-- New Terminal Loader -->
    <div id="loading-text">
        <div class="terminal-loader">
            <div class="terminal-header">
                <div class="terminal-title">Status</div>
                <div class="terminal-controls">
                    <div class="control close"></div>
                    <div class="control minimize"></div>
                    <div class="control maximize"></div>
                </div>
            </div>
            <div class="text">Loading...</div>
        </div>
    </div>

    <canvas id="canvas">Your browser does not support the canvas tag.</canvas>
    <noscript>Your browser does not support JavaScript.</noscript>

    <div id="status">
        <img id="status-splash" class="show-image--true fullsize--true use-filter--true" src="buckshot-roulette.png" alt="">
        <progress id="status-progress"></progress>
        <div id="status-notice"></div>
    </div>

    <script src="buckshot-roulette.js"></script>
    <script>
        const GODOT_CONFIG = {
            "args": [],
            "canvasResizePolicy": 2,
            "ensureCrossOriginIsolationHeaders": false,
            "executable": "buckshot-roulette",
            "experimentalVK": false,
            "fileSizes": {
                "buckshot-roulette.pck": 344705792,
                "buckshot-roulette.wasm": 43444261
            },
            "focusCanvas": false,
            "gdextensionLibs": []
        };
        const GODOT_THREADS_ENABLED = false;
        const engine = new Engine(GODOT_CONFIG);

        function run() {
            const loadingText = document.getElementById('loading-text');
            const statusOverlay = document.getElementById('status');
            const statusProgress = document.getElementById('status-progress');
            const statusNotice = document.getElementById('status-notice');
            loadingText.remove();
            let initializing = true;
            let statusMode = '';

            function setStatusMode(mode) {
                if (statusMode === mode || !initializing) return;
                if (mode === 'hidden') {
                    statusOverlay.remove();
                    initializing = false;
                    return;
                }
                statusOverlay.style.visibility = 'visible';
                statusProgress.style.display = mode === 'progress' ? 'block' : 'none';
                statusNotice.style.display = mode === 'notice' ? 'block' : 'none';
                statusMode = mode;
            }

            function setStatusNotice(text) {
                while (statusNotice.lastChild) statusNotice.removeChild(statusNotice.lastChild);
                const lines = text.split('\n');
                lines.forEach(line => {
                    statusNotice.appendChild(document.createTextNode(line));
                    statusNotice.appendChild(document.createElement('br'));
                });
            }

            function displayFailureNotice(err) {
                console.error(err);
                if (err instanceof Error) {
                    setStatusNotice(err.message);
                } else if (typeof err === 'string') {
                    setStatusNotice(err);
                } else {
                    setStatusNotice('An unknown error occurred.');
                }
                setStatusMode('notice');
                initializing = false;
            }

            const missing = Engine.getMissingFeatures({ threads: GODOT_THREADS_ENABLED });
            if (missing.length !== 0) {
                if (GODOT_CONFIG['serviceWorker'] && GODOT_CONFIG['ensureCrossOriginIsolationHeaders'] && 'serviceWorker' in navigator) {
                    let serviceWorkerRegistrationPromise;
                    try {
                        serviceWorkerRegistrationPromise = navigator.serviceWorker.getRegistration();
                    } catch (err) {
                        serviceWorkerRegistrationPromise = Promise.reject(new Error('Service worker registration failed.'));
                    }

                    Promise.race([
                        serviceWorkerRegistrationPromise.then((registration) => {
                            if (registration != null) {
                                return Promise.reject(new Error('Service worker already exists.'));
                            }
                            return registration;
                        }).then(() => engine.installServiceWorker()),
                        new Promise((resolve) => setTimeout(() => resolve(), 2000)),
                    ]).then(() => window.location.reload())
                        .catch((err) => console.error('Error while registering service worker:', err));
                } else {
                    const missingMsg = 'Error\nThe following features required to run Godot projects on the Web are missing:\n';
                    displayFailureNotice(missingMsg + missing.join('\n'));
                }
            } else {
                setStatusMode('progress');
                engine.startGame({
                    'onProgress': function (current, total) {
                        if (current > 0 && total > 0) {
                            statusProgress.value = current;
                            statusProgress.max = total;
                        } else {
                            statusProgress.removeAttribute('value');
                            statusProgress.removeAttribute('max');
                        }
                    },
                }).then(() => {
                    setStatusMode('hidden');
                }, displayFailureNotice);
            }
        };
        window.godotRunStart = run;
    </script>
</body>
</html>
